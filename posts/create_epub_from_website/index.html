<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><title>抓網站內容做成電子書 (epub) | Ryan's blog</title><link rel=stylesheet href=https://blog.prpr.tw/css/simpleness.css><link rel=canonical href=https://blog.prpr.tw/posts/create_epub_from_website/><link rel=alternate type=application/rss+xml href title="Ryan's blog"><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css rel=stylesheet></head><body class=container><nav class=navigation><div class=nav-left><div class="nav-item nav-title"><a href=https://blog.prpr.tw/>Ryan's blog</a></div><div class="nav-item nav-menu"><a href=/categories/coding>Coding</a>
<a href=/categories/hiking>Hiking</a></div></div><div class="nav-item nav-right fontawesome"><a href=https://twitter.com/v_kiiii target=_blank><i title=Twitter class="fab fa-twitter"></i></a>
<a href=https://github.com/ryanchentw target=_blank><i title=GitHub class="fab fa-github"></i></a></div></nav><article class=post><header class=post-header><h1 style=text-align:center>抓網站內容做成電子書 (epub)</h1><div class=post-metadata><time datetime=2022-06-18T11:52:41+08:00>June 18, 2022</time> &nbsp;</div></header><div class=post-text><p><img src=https://i.imgur.com/MnSCg5R.jpg alt=alt></p><p>買了 BOOX note5 之後, 覺得電子紙螢幕呈現效果真舒服, 所有要長時間閱讀的東西都想丟進去.
另外發現雖然系統用 Android 11, 理論上可以裝所有 Android App, 包含瀏覽器,
不過在裝了一堆 App 發現都是虛幻, 排版與文字呈現還是用 epub 格式最好.</p><p>本次範例使用 <a href=https://pypi.org/project/EbookLib/>EbookLib</a>, <a href=https://pypi.org/project/requests/>requests</a></p><p>以及 mark_mew 大大的<a href=https://ithelp.ithome.com.tw/users/20141518/ironman/4653>關於我幫新公司建立整套部屬流程那檔事</a> 為範例
感謝 mark_mew 大大分享自身經驗</p><p>另外粗粗產生出來的 epub 還是有很多排版問題要修, 像是圖片不見了, script tag 跑出來了, 在過一層 strip_tags 應該會好一點.
看來最適合的還是轉小說進去 (?</p><p>這次網頁數量不多用 requests 抓抓就好, 就不寫 scrapy 了, 抓別人網站注意禮貌</p><p>程式分成四段, 第四段跟 ebooklib 範例程式只有差異在產生 sections 部分</p><ul><li>抓內容網址</li><li>抓內容 -> local file</li><li>建立章節</li><li>寫成 epub</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> ebooklib <span style=color:#f92672>import</span> epub
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> lxml.html <span style=color:#f92672>import</span> fromstring
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> tqdm <span style=color:#f92672>import</span> tqdm
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 抓內容的網址</span>
</span></span><span style=display:flex><span>urls <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>headers<span style=color:#f92672>=</span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;User-Agent&#34;</span>: <span style=color:#e6db74>&#34;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.0.0 Safari/537.36&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>page_urls <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;https://ithelp.ithome.com.tw/users/20141518/ironman/4653&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;https://ithelp.ithome.com.tw/users/20141518/ironman/4653?page=2&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;https://ithelp.ithome.com.tw/users/20141518/ironman/4653?page=3&#39;</span>,
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> url <span style=color:#f92672>in</span> tqdm(page_urls):
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>    tree <span style=color:#f92672>=</span> fromstring(response<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>    urls <span style=color:#f92672>+=</span> [s<span style=color:#f92672>.</span>strip() <span style=color:#66d9ef>for</span> s <span style=color:#f92672>in</span> tree<span style=color:#f92672>.</span>xpath(<span style=color:#e6db74>&#39;//h3[@class=&#34;qa-list__title&#34;]/a/@href&#39;</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 抓內容</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> url <span style=color:#f92672>in</span> tqdm(urls):
</span></span><span style=display:flex><span>    fname <span style=color:#f92672>=</span> url<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;/&#39;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(fname, <span style=color:#e6db74>&#39;w&#39;</span>) <span style=color:#66d9ef>as</span> wf:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        wf<span style=color:#f92672>.</span>write(response<span style=color:#f92672>.</span>text)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 建立章節</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>build_sections</span>():
</span></span><span style=display:flex><span>    sections <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> fname <span style=color:#f92672>in</span> tqdm(sorted(os<span style=color:#f92672>.</span>listdir(<span style=color:#e6db74>&#39;./ebooks&#39;</span>))):  <span style=color:#75715e># 利用檔案名稱排章節順序</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;.&#39;</span> <span style=color:#f92672>in</span> fname:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;./ebooks/&#39;</span> <span style=color:#f92672>+</span> fname) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>            tree <span style=color:#f92672>=</span> fromstring(f<span style=color:#f92672>.</span>read())
</span></span><span style=display:flex><span>            title <span style=color:#f92672>=</span> tree<span style=color:#f92672>.</span>xpath(<span style=color:#e6db74>&#39;//h2[@class=&#34;qa-header__title ir-article__title&#34;]/text()&#39;</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>            content <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(list(tree<span style=color:#f92672>.</span>xpath(<span style=color:#e6db74>&#39;//div[@class=&#34;qa-panel__content&#34;]&#39;</span>)[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>itertext()))
</span></span><span style=display:flex><span>            content <span style=color:#f92672>=</span> content<span style=color:#f92672>.</span>replace(<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&lt;br/&gt;&#39;</span>)
</span></span><span style=display:flex><span>            section <span style=color:#f92672>=</span> epub<span style=color:#f92672>.</span>EpubHtml(title<span style=color:#f92672>=</span>title, file_name<span style=color:#f92672>=</span>fname, lang<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;zh-hant&#39;</span>)
</span></span><span style=display:flex><span>            section<span style=color:#f92672>.</span>content <span style=color:#f92672>=</span> content
</span></span><span style=display:flex><span>            sections<span style=color:#f92672>.</span>append(section)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> build_sections
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 寫成 epub</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> ebooklib <span style=color:#f92672>import</span> epub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>book <span style=color:#f92672>=</span> epub<span style=color:#f92672>.</span>EpubBook()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># set metadata</span>
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>set_identifier(<span style=color:#e6db74>&#39;ithome_ironman_4653&#39;</span>)
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>set_title(<span style=color:#e6db74>&#39;關於我幫新公司建立整套部屬流程那檔事&#39;</span>)
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>set_language(<span style=color:#e6db74>&#39;zh-hant&#39;</span>)
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>add_author(<span style=color:#e6db74>&#39;mark_mew&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># create chapter</span>
</span></span><span style=display:flex><span>sections <span style=color:#f92672>=</span> build_sections()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add chapter</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> section <span style=color:#f92672>in</span> sections:
</span></span><span style=display:flex><span>    book<span style=color:#f92672>.</span>add_item(section)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># define Table Of Contents</span>
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>toc <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>    epub<span style=color:#f92672>.</span>Link(section<span style=color:#f92672>.</span>file_name, section<span style=color:#f92672>.</span>title, section<span style=color:#f92672>.</span>title)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> section <span style=color:#f92672>in</span> sections
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add default NCX and Nav file</span>
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>add_item(epub<span style=color:#f92672>.</span>EpubNcx())
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>add_item(epub<span style=color:#f92672>.</span>EpubNav())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># define CSS style</span>
</span></span><span style=display:flex><span>style <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;BODY {color: white;}&#39;</span>
</span></span><span style=display:flex><span>nav_css <span style=color:#f92672>=</span> epub<span style=color:#f92672>.</span>EpubItem(uid<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;style_nav&#34;</span>, file_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;style/nav.css&#34;</span>, media_type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;text/css&#34;</span>, content<span style=color:#f92672>=</span>style)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add CSS file</span>
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>add_item(nav_css)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># basic spine</span>
</span></span><span style=display:flex><span>book<span style=color:#f92672>.</span>spine <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;nav&#39;</span>] <span style=color:#f92672>+</span> sections
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># write to the file</span>
</span></span><span style=display:flex><span>epub<span style=color:#f92672>.</span>write_epub(<span style=color:#e6db74>&#39;關於我幫新公司建立整套部屬流程那檔事.epub&#39;</span>, book, {})
</span></span></code></pre></div></div><footer class=post-footer></footer><div class=comments><div class=comments></div></div></article><div class=foot>&copy; - 2022 &#183;
<a href=/>Ryan's blog</a> &#183;
Theme <a href=https://github.com/RainerChiang/simpleness>Simpleness</a> Powered by <a href=https://gohugo.io/>Hugo</a> &#183;
<a href=#><i class="fas fa-chevron-up"></i></a></div></body></html>