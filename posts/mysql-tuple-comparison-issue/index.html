<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.98.0"><title>Mysql Tuple Comparison Issue | Ryan's blog</title><link rel=stylesheet href=https://blog.prpr.tw/css/simpleness.css><link rel=canonical href=https://blog.prpr.tw/posts/mysql-tuple-comparison-issue/><link rel=alternate type=application/rss+xml href title="Ryan's blog"><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css rel=stylesheet></head><body class=container><nav class=navigation><div class=nav-left><div class="nav-item nav-title"><a href=https://blog.prpr.tw/>Ryan's blog</a></div><div class="nav-item nav-menu"><a href=/categories/coding>Coding</a>
<a href=/categories/hiking>Hiking</a></div></div><div class="nav-item nav-right fontawesome"><a href=https://twitter.com/v_kiiii target=_blank><i title=Twitter class="fab fa-twitter"></i></a>
<a href=https://github.com/ryanchentw target=_blank><i title=GitHub class="fab fa-github"></i></a></div></nav><article class=post><header class=post-header><h1 style=text-align:center>Mysql Tuple Comparison Issue</h1><div class=post-metadata><time datetime=2017-12-09T13:19:56+08:00>December 09, 2017</time> &nbsp;
<i class="fas fa-folder"></i>
<a href=/categories/coding>coding</a>
&nbsp;</div></header><div class=post-text><p>MySQL 5.6 tuple comparison bug</p><p>這是一個用 IN clause 比較 primary key 卻得到 full table scan 的故事</p><p><img src=https://i.imgur.com/LIOTPaT.jpg alt=Imgur></p><p>tl; dr</p><pre tabindex=0><code>升級 mysql &gt;= 5.7, 改用 and, or 形式串接條件
</code></pre><p>Tuple Comparison Example</p><pre tabindex=0><code>select * from users where (first_name, last_name) in (
    (&#39;John&#39;, &#39;Doe&#39;),
    (&#39;Haragaki&#39;, &#39;Yui&#39;),
)
</code></pre><p>一開始直覺寫出 IN 的版本（因為 IN 好棒棒會用 <a href=https://dev.mysql.com/doc/refman/5.7/en/comparison-operators.html#function_in>binary search</a>），結果 explain check 一看居然是 full table scan，昏倒。
想一下用 and + or 串接改看看</p><pre tabindex=0><code>select * from users where
    (first_name=&#39;John&#39; and last_name=&#39;Doe&#39;) or
    (first_name=&#39;Haragaki&#39; and last_name=&#39;Yui&#39;)
)
</code></pre><p>哎唷不錯喔有吃到 index，就這樣先把 fix 丟上線。</p><p>過陣子比較閒來挖一下問題出在哪</p><p>翻到 <a href=https://stackoverflow.com/questions/16117492/different-approach-of-using-in-clause-in-mysql>stackoverflow</a> 上的相關討論，列舉出 IN clause 的幾種使用方式，正是他說的第三種 tuple comparison
後面評論也給出 Percona <a href=https://www.percona.com/blog/2008/04/04/multi-column-in-clause-unexpected-mysql-issue/>一篇文章</a></p><p>指出是個 bug，而且這邊還是 2008 年的文章，一個好的 bug 果然是歷久彌新</p><p>懶得架環境，用<a href=https://www.db-fiddle.com/f/xpwiDid8dxHFVvKfD2sgxW/0>線上環境</a>測一下，
看其他版本有沒有這問題。</p><p>看起來在 MySQL 5.7 解決了，不巧公司用的是 5.6 只好先繼續用 workaround 耶嘿嘿</p><p>Ref:</p><ul><li><a href=https://stackoverflow.com/questions/16117492/different-approach-of-using-in-clause-in-mysql>https://stackoverflow.com/questions/16117492/different-approach-of-using-in-clause-in-mysql</a></li><li><a href=https://www.percona.com/blog/2008/04/04/multi-column-in-clause-unexpected-mysql-issue/>https://www.percona.com/blog/2008/04/04/multi-column-in-clause-unexpected-mysql-issue/</a></li><li><a href=https://www.db-fiddle.com/f/xpwiDid8dxHFVvKfD2sgxW/0>https://www.db-fiddle.com/f/xpwiDid8dxHFVvKfD2sgxW/0</a></li></ul></div><footer class=post-footer><div class=post-tags><i class="fas fa-tags"></i>
<a href=/tags/mysql>MySQL</a>
&nbsp;</div></footer><div class=comments><div class=comments></div></div></article><div class=foot>&copy; - 2022 &#183;
<a href=/>Ryan's blog</a> &#183;
Theme <a href=https://github.com/RainerChiang/simpleness>Simpleness</a> Powered by <a href=https://gohugo.io/>Hugo</a> &#183;
<a href=#><i class="fas fa-chevron-up"></i></a></div></body></html>