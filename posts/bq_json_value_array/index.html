<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.104.3"><title>BigQuery JSON_VALUE_ARRAY, JSON_QUERY_ARRAY 差異跟小雷 | Ryan's blog</title><link rel=stylesheet href=https://blog.prpr.tw/css/simpleness.css><link rel=canonical href=https://blog.prpr.tw/posts/bq_json_value_array/><link rel=alternate type=application/rss+xml href title="Ryan's blog"><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css rel=stylesheet></head><body class=container><nav class=navigation><div class=nav-left><div class="nav-item nav-title"><a href=https://blog.prpr.tw/>Ryan's blog</a></div><div class="nav-item nav-menu"><a href=/categories/coding>Coding</a>
<a href=/categories/hiking>Hiking</a></div></div><div class="nav-item nav-right fontawesome"><a href=https://twitter.com/v_kiiii target=_blank><i title=Twitter class="fab fa-twitter"></i></a>
<a href=https://github.com/ryanchentw target=_blank><i title=GitHub class="fab fa-github"></i></a></div></nav><article class=post><header class=post-header><h1 style=text-align:center>BigQuery JSON_VALUE_ARRAY, JSON_QUERY_ARRAY 差異跟小雷</h1><div class=post-metadata><time datetime=2022-10-28T11:45:27+08:00>October 28, 2022</time> &nbsp;</div></header><div class=post-text><p>JSON_VALUE_ARRAY 只吃 scalar value</p><p>任何不在 {string, number,boolean} 都會變成 NULL, 像是</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> JSON_VALUE_ARRAY(<span style=color:#e6db74>&#39;{&#34;product_ids&#34;: [UCCU]}&#39;</span>, <span style=color:#e6db74>&#34;$.product_ids&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>--
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>Row</span>	f0_	
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>	<span style=color:#66d9ef>null</span>
</span></span></code></pre></div><p>但如果裡面有 NULL 則會噴錯</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> JSON_VALUE_ARRAY(<span style=color:#e6db74>&#39;{&#34;product_ids&#34;: [null]}&#39;</span>, <span style=color:#e6db74>&#34;$.product_ids&#34;</span>);
</span></span></code></pre></div><blockquote><p>Array cannot have a null element; error in writing field f0_</p></blockquote><p>啊如果我就是要 scalar value 裡面又可能有 null 怎麼辦？
這邊可以改用 <a href=https://cloud.google.com/bigquery/docs/reference/standard-sql/json_functions#function_overview>JSON_QUERY_ARRAY</a> 替代，但因為 output 不同（多了 double quote），視資料情況可以直接 trim 掉處理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    ARRAY(<span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>TRIM</span>(item, <span style=color:#e6db74>&#39;&#34;&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>UNNEST</span>(JSON_QUERY_ARRAY(<span style=color:#e6db74>&#39;{&#34;product_ids&#34;: [null, 1, 2, 3]}&#39;</span>, <span style=color:#e6db74>&#34;$.product_ids&#34;</span>)) <span style=color:#66d9ef>AS</span> item);
</span></span></code></pre></div></div><footer class=post-footer></footer><div class=comments><div class=comments></div></div></article><div class=foot>&copy; - 2022 &#183;
<a href=/>Ryan's blog</a> &#183;
Theme <a href=https://github.com/RainerChiang/simpleness>Simpleness</a> Powered by <a href=https://gohugo.io/>Hugo</a> &#183;
<a href=#><i class="fas fa-chevron-up"></i></a></div></body></html>